<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">

<!-- iOS / Safari SAFE -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<title>Control de Gastos</title>
<link rel="icon" type="image/png" href="icono.png">

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --primary:#007bff;--primary-hover:#0056c7;--danger:#d9534f;
  --bg:#f4f4f4;--card:#ffffff;--text:#333;
}
html,body{
  font-family:Arial,Helvetica,sans-serif;
  margin:0;padding:15px;
  background:var(--bg);color:var(--text);
  overflow-x:hidden;
  -webkit-text-size-adjust:100%;
}
.card{
  background:var(--card);padding:15px;margin-bottom:20px;
  border-radius:8px;box-shadow:0 0 6px rgba(0,0,0,.1);
}
input,select,button{
  padding:10px;margin:5px 8px 5px 0;border-radius:6px;
  border:1px solid #ccc;font-size:16px;
}
button{
  background:var(--primary);color:white;border:none;
  touch-action:manipulation;
}
button:active{opacity:.85}
.btn-danger{background:var(--danger);}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{padding:10px;border-bottom:1px solid #ddd;text-align:left;}
.row{display:flex;flex-wrap:wrap;gap:20px;}
.col{flex:1 1 340px;}
.chart-wrapper{position:relative;width:100%;min-height:260px;}
@media (hover:none){button:hover{background:var(--primary);}}
</style>
</head>

<body>

<h1>üìä Control de Gastos</h1>

<!-- ================= REGISTRO ================= -->
<div class="card">
<h2>Registrar movimiento</h2>

<input type="text" id="monto" inputmode="decimal" placeholder="Monto 0.00">

<select id="tipo">
  <option value="entrada">Entrada</option>
  <option value="salida">Gasto</option>
</select>

<select id="grupoCategorias" onchange="filtrarCategoriasPorGrupo()">
  <option value="all">Todas</option>
  <option value="alimentacion">Alimentaci√≥n</option>
  <option value="transporte">Transporte</option>
  <option value="hogar">Hogar</option>
  <option value="mandado">Mandado</option>
  <option value="tecnologia">Tecnolog√≠a</option>
  <option value="personales">Personales</option>
  <option value="trabajo">Trabajo</option>
  <option value="salud">Salud</option>
  <option value="ninos">Ni√±os</option>
  <option value="mascotas">Mascotas</option>
</select>

<select id="categoria"></select>

<button onclick="agregarMovimiento()">Agregar</button>
</div>

<!-- ================= FILTROS ================= -->
<div class="card">
<h2>Movimientos</h2>

<input type="month" id="mesFiltro">
<select id="categoriaFiltro"></select>
<button onclick="filtrarPorMes()">Mes</button>
<button onclick="filtrarPorCategoria()">Categor√≠a</button>
<button onclick="limpiarFiltros()">Quitar filtros</button>

<table>
<thead>
<tr>
<th>Monto</th>
<th>Tipo</th>
<th>Categor√≠a</th>
<th>Fecha</th>
<th></th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</div>

<!-- ================= RES√öMENES ================= -->
<div class="row">
<div class="card col">
<h3>Totales</h3>
<p>Entradas hoy: <b id="entradaDia">0</b></p>
<p>Gastos hoy: <b id="salidaDia">0</b></p>
<p>Entradas semana: <b id="entradaSemana">0</b></p>
<p>Gastos semana: <b id="salidaSemana">0</b></p>
<p>Balance general: <b id="balanceGeneral">0</b></p>
</div>
</div>

<!-- ================= GR√ÅFICAS ================= -->
<div class="row">
<div class="card col">
<h3>Balance por Categor√≠a</h3>
<div class="chart-wrapper"><canvas id="grafica"></canvas></div>
</div>

<div class="card col">
<h3>Comparativa Mensual</h3>
<select id="rangoMeses" onchange="actualizarGraficaMensual()">
<option value="6">6 meses</option>
<option value="12" selected>12 meses</option>
<option value="24">24 meses</option>
</select>
<div class="chart-wrapper"><canvas id="graficaMensual"></canvas></div>
</div>
</div>

<div class="row">
<div class="card col">
<h3>Ingresos por Categor√≠a</h3>
<div class="chart-wrapper"><canvas id="graficaIngresos"></canvas></div>
</div>

<div class="card col">
<h3>Gastos por Categor√≠a</h3>
<div class="chart-wrapper"><canvas id="graficaGastos"></canvas></div>
</div>
</div>

<button onclick="exportarExcel()">üì• Exportar Excel</button>
<button class="btn-danger" onclick="borrarTodosLosDatos()">üóë Borrar todo</button>

<script>
/* ================= DATOS ================= */
let movimientos=[],movimientosFiltrados=[];
let grafica,graficaMensual,graficaIngresos,graficaGastos;

/* ================= CATEGOR√çAS ================= */
const gruposCategorias={
alimentacion:["Desayuno","Comida","Cena","Snacks","Caf√©","Panader√≠a","Tortillas"],
transporte:["Uber/Didi","Cami√≥n","Estacionamiento","Casetas","Gasolina"],
hogar:["Agua Garraf√≥n","Limpieza","Papel Higi√©nico","Focos","Gas LP"],
mandado:["Verduras","Frutas","Carnes","Pan","Refrescos","Mandado"],
tecnologia:["Recarga tel√©fono","Impresiones","Tel√©fono"],
personales:["Aseo personal","Helado","Regalo peque√±o","Chivo","Manutenci√≥n","Mis Gastos","Otros"],
trabajo:["Herramientas","Material oficina","Refacciones peque√±as","N√≥mina"],
salud:["Medicinas","Curitas"],
ninos:["Lonche escolar","√ötiles escolares"],
mascotas:["Comida mascota","Arena"]
};

let todasLasCategorias=[...new Set(Object.values(gruposCategorias).flat())];

/* ================= UTIL ================= */
function formatoFechaIOS(f){
const d=new Date(f);
return d.toLocaleDateString("es-MX")+" "+d.toLocaleTimeString("es-MX",{hour:"2-digit",minute:"2-digit"});
}
function guardar(){localStorage.setItem("movimientos",JSON.stringify(movimientos))}
function cargar(){
const d=localStorage.getItem("movimientos");
if(d)movimientos=JSON.parse(d).map(m=>({...m,fecha:new Date(m.fecha)}))
}

/* ================= CARGA SELECTS ================= */
function cargarCategorias(){
categoria.innerHTML="";
categoriaFiltro.innerHTML='<option value="">Todas</option>';
todasLasCategorias.forEach(c=>{
categoria.innerHTML+=`<option>${c}</option>`;
categoriaFiltro.innerHTML+=`<option>${c}</option>`;
});
}
function filtrarCategoriasPorGrupo(){
const g=grupoCategorias.value;
categoria.innerHTML="";
(g==="all"?todasLasCategorias:gruposCategorias[g]).forEach(c=>{
categoria.innerHTML+=`<option>${c}</option>`;
});
}

/* ================= CRUD ================= */
function agregarMovimiento(){
const monto=parseFloat(montoInput.value.replace(",","."));
if(!monto||monto<=0)return alert("Monto inv√°lido");
movimientos.push({
monto,
tipo:tipo.value,
categoria:categoria.value,
fecha:new Date()
});
guardar();actualizar();montoInput.value="";
}
const montoInput=document.getElementById("monto");

function eliminar(i){
if(!confirm("¬øEliminar?"))return;
movimientos.splice(i,1);guardar();actualizar();
}

/* ================= TABLA ================= */
function actualizarTabla(){
tabla.innerHTML="";
const lista=movimientosFiltrados.length?movimientosFiltrados:movimientos;
lista.forEach((m,i)=>{
tabla.innerHTML+=`
<tr>
<td>$${m.monto.toFixed(2)}</td>
<td>${m.tipo}</td>
<td>${m.categoria}</td>
<td>${formatoFechaIOS(m.fecha)}</td>
<td><button onclick="eliminar(${i})">‚ùå</button></td>
</tr>`;
});
}

/* ================= TOTALES ================= */
function actualizarTotales(){
let e=0,s=0,es=0,ss=0;
const hoy=new Date().toDateString();
movimientos.forEach(m=>{
const diff=(new Date()-m.fecha)/86400000;
if(m.tipo==="entrada"){e+=m.monto;if(diff<7)es+=m.monto;}
else{s+=m.monto;if(diff<7)ss+=m.monto;}
});
entradaDia.textContent=e.toFixed(2);
salidaDia.textContent=s.toFixed(2);
entradaSemana.textContent=es.toFixed(2);
salidaSemana.textContent=ss.toFixed(2);
balanceGeneral.textContent=(e-s).toFixed(2);
}

/* ================= GR√ÅFICAS ================= */
function actualizarGraficas(){
const cats={};
movimientos.forEach(m=>{
cats[m.categoria]=cats[m.categoria]||{e:0,s:0};
m.tipo==="entrada"?cats[m.categoria].e+=m.monto:cats[m.categoria].s+=m.monto;
});
const labels=Object.keys(cats);
const ent=labels.map(l=>cats[l].e);
const sal=labels.map(l=>cats[l].s);

if(grafica)grafica.destroy();
grafica=new Chart(document.getElementById("grafica"),{
type:"bar",
data:{labels,datasets:[
{label:"Entradas",data:ent},
{label:"Gastos",data:sal}
]},
options:{responsive:true,maintainAspectRatio:false}
});

if(graficaIngresos)graficaIngresos.destroy();
graficaIngresos=new Chart(document.getElementById("graficaIngresos"),{
type:"pie",data:{labels,datasets:[{data:ent}]},
options:{responsive:true}
});

if(graficaGastos)graficaGastos.destroy();
graficaGastos=new Chart(document.getElementById("graficaGastos"),{
type:"pie",data:{labels,datasets:[{data:sal}]},
options:{responsive:true}
});
}

/* ================= GR√ÅFICA MENSUAL ================= */
function actualizarGraficaMensual(){
const rango=parseInt(rangoMeses.value);
const hoy=new Date(),data={};
movimientos.forEach(m=>{
const diff=(hoy.getFullYear()-m.fecha.getFullYear())*12+(hoy.getMonth()-m.fecha.getMonth());
if(diff<rango){
const k=`${m.fecha.getFullYear()}-${String(m.fecha.getMonth()+1).padStart(2,"0")}`;
data[k]=data[k]||{e:0,s:0};
m.tipo==="entrada"?data[k].e+=m.monto:data[k].s+=m.monto;
}
});
const labels=Object.keys(data).sort();
if(graficaMensual)graficaMensual.destroy();
graficaMensual=new Chart(document.getElementById("graficaMensual"),{
type:"line",
data:{labels,datasets:[
{label:"Entradas",data:labels.map(l=>data[l].e)},
{label:"Gastos",data:labels.map(l=>data[l].s)}
]},
options:{responsive:true,maintainAspectRatio:false}
});
}

/* ================= FILTROS ================= */
function filtrarPorMes(){
if(!mesFiltro.value)return;
const[a,m]=mesFiltro.value.split("-").map(Number);
movimientosFiltrados=movimientos.filter(x=>x.fecha.getFullYear()===a&&x.fecha.getMonth()+1===m);
actualizar();
}
function filtrarPorCategoria(){
movimientosFiltrados=categoriaFiltro.value?
movimientos.filter(x=>x.categoria===categoriaFiltro.value):[];
actualizar();
}
function limpiarFiltros(){
movimientosFiltrados=[];
mesFiltro.value="";
categoriaFiltro.value="";
actualizar();
}

/* ================= EXCEL ================= */
function exportarExcel(){
const ws=XLSX.utils.json_to_sheet(movimientos.map(m=>({
Monto:m.monto,Tipo:m.tipo,Categoria:m.categoria,Fecha:formatoFechaIOS(m.fecha)
})));
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Movimientos");
const wbout=XLSX.write(wb,{bookType:"xlsx",type:"array"});
const blob=new Blob([wbout],{type:"application/octet-stream"});
const url=URL.createObjectURL(blob);
const a=document.createElement("a");
a.href=url;a.download="control_gastos.xlsx";a.click();
URL.revokeObjectURL(url);
}

/* ================= BORRAR ================= */
function borrarTodosLosDatos(){
if(!confirm("¬øBorrar todo?"))return;
movimientos=[];guardar();actualizar();
}

/* ================= UPDATE ================= */
function actualizar(){
actualizarTabla();
actualizarTotales();
actualizarGraficas();
actualizarGraficaMensual();
}

document.addEventListener("DOMContentLoaded",()=>{
cargar();
cargarCategorias();
filtrarCategoriasPorGrupo();
actualizar();
});
</script>
</body>
</html>
